# nonebot-plugin-maimai-raking

一个基于 NoneBot2 的舞萌 DX 分群排行榜插件

## ✨ 功能特性

### 🎮 核心功能
- **分群管理**：每个群组独立管理排行榜数据，互不干扰
- **权限控制**：超级管理员、群管理员、群主可以开关功能和管理成员
- **排行榜系统**：用户可自愿加入/退出群内排行榜，支持管理员为他人操作
- **智能昵称**：优先显示群名片，自动更新，提升用户识别度

### 🔄 自动更新
- 每天凌晨 **0:00** 自动更新所有用户的成绩数据
- 每天凌晨 **0:05** 自动更新歌曲别名库
- 每 **5 分钟**自动刷新所有启用群的用户昵称
- 用户加入排行榜时自动刷新该群所有成员的昵称

### 🎵 歌曲查询
- 支持歌曲名、别名、ID 多种方式查询
- 支持模糊匹配和智能搜索
- 可指定难度查询（绿/黄/红/紫/白）
- 默认显示最高难度的排行榜

### 🖼️ 美观展示
- 精美的排行榜图片展示
- 包含封面、难度、成绩、评级等完整信息
- 显示前 20 名，避免图片过长
- 自适应长昵称显示，支持换行

### 💾 高效存储
- 基于 **SQLite 数据库**存储，性能优异
- 智能缓存歌曲封面和别名数据
- 支持事务处理，数据安全可靠
- 自动创建索引，查询速度快

## 📦 安装

使用 pip 安装：

```bash
pip install nonebot-plugin-maimai-raking
```

或使用 nb-cli：

```bash
nb plugin install nonebot-plugin-maimai-raking
```

## ⚙️ 配置

在 `.env` 文件中添加以下配置：

```env
# 水鱼查分器 Developer Token（必填）
MAIMAI_DEVELOPER_TOKEN=your_developer_token_here

# 数据存储路径（可选，默认为 data/maimai_raking）
MAIMAI_DATA_PATH=data/maimai_raking
```

### 获取 Developer Token

1. 访问 [水鱼查分器](https://www.diving-fish.com/maimaidx/prober/)
2. 登录你的账号
3. 进入"编辑个人资料"页面
4. 在"需要查分器中的玩家数据用于其他应用程序开发？请点击这里~"中申请 Developer Token

## 📖 使用方法

### 管理员命令

以下命令需要**群主、管理员或超级管理员**权限：

| 命令 | 说明 |
|------|------|
| `开启舞萌排行榜` | 在当前群开启排行榜功能 |
| `关闭舞萌排行榜` | 在当前群关闭排行榜功能 |
| `刷新排行榜` | 手动刷新当前群所有成员的成绩数据 |
| `刷新群昵称` | 手动刷新当前群所有成员的群昵称 |
| `加入排行榜 <QQ号>` | 为指定 QQ 号的用户加入排行榜 |
| `退出排行榜 <QQ号>` | 为指定 QQ 号的用户退出排行榜 |

### 用户命令

| 命令 | 说明 |
|------|------|
| `加入排行榜` | 加入当前群的排行榜 |
| `退出排行榜` | 退出当前群的排行榜 |
| `wmrk <歌曲名/别名/ID>` | 查询该歌曲在本群的排行榜（默认最高难度）|
| `wmrk <歌曲名/别名/ID> <难度>` | 查询指定难度的排行榜 |
| `wmbm <歌曲名/别名/ID>` | 查询歌曲的详细信息 |
| `wmrt` | 查看本群全部 Rating 排行榜（前 10 名）|
| `wmrt<分段>` | 查看指定分段的 Rating 排行榜（前 10 名）|

#### 难度参数

- `绿` - Basic
- `黄` - Advanced
- `红` - Expert
- `紫` - Master
- `白` - Re:Master

#### Rating 分段参数

- `wmrt` - 查询全部玩家
- `wmrt1` - 查询 11000-11999 分段
- `wmrt2` - 查询 12000-12999 分段
- `wmrt3` - 查询 13000-13999 分段
- `wmrt4` - 查询 14000-14999 分段
- `wmrt5` - 查询 15000-15999 分段
- `wmrt6` - 查询 16000-16999 分段
- 以此类推...

### 使用示例

#### 用户操作

```
# 加入排行榜
用户: 加入排行榜
Bot: ✅ 已成功加入排行榜！
     昵称: 玩家A
     Rating: 14500

# 查询歌曲排行榜（默认最高难度）
用户: wmrk 群青
Bot: [返回群青最高难度(紫)的排行榜图片]

# 查询指定难度
用户: wmrk 群青 红
Bot: [返回群青 Expert 难度的排行榜图片]

# 使用别名查询
用户: wmrk qunqing
Bot: [返回群青的排行榜图片]

# 使用 ID 查询
用户: wmrk 12345
Bot: [返回对应歌曲的排行榜图片]

# 查询歌曲详细信息
用户: wmbm 群青
Bot: 🎵 歌曲信息
     📝 名称: 群青
     🆔 ID: 12345
     📊 类型: DX谱面
     🏷️ 别名 (3个):
     qunqing
     群青
     群青の夏

# 查询 Rating 排行榜（全部）
用户: wmrt
Bot: 🏆 本群 Rating 排行榜 TOP 10
     ==============================
     🥇 玩家A
        Rating: 15000
     🥈 玩家B
        Rating: 14800
     🥉 玩家C
        Rating: 14500
     4. 玩家D
        Rating: 14200
     ...
     ==============================

# 查询指定分段 Rating 排行榜
用户: wmrt5
Bot: 🏆 本群 Rating 排行榜 W5 TOP 5
     ==============================
     🥇 玩家A
        Rating: 15888
     🥈 玩家B
        Rating: 15666
     🥉 玩家C
        Rating: 15234
     4. 玩家D
        Rating: 15100
     5. 玩家E
        Rating: 15000
     ==============================
     该分段共 5 人

用户: wmrt4
Bot: 🏆 本群 Rating 排行榜 W4 TOP 3
     ==============================
     🥇 玩家F
        Rating: 14999
     🥈 玩家G
        Rating: 14800
     🥉 玩家H
        Rating: 14500
     ==============================
     该分段共 3 人
```

#### 管理员操作

```
# 开启排行榜功能
管理员: 开启舞萌排行榜
Bot: ✅ 已在本群开启舞萌排行榜功能！

# 刷新排行榜数据
管理员: 刷新排行榜
Bot: 正在刷新排行榜数据，请稍候...
Bot: 刷新完成！
     成功: 10 人
     失败: 0 人

# 刷新群昵称
管理员: 刷新群昵称
Bot: 正在刷新群昵称，共 10 位用户...
Bot: ✅ 群昵称刷新完成！

# 为他人加入排行榜
管理员: 加入排行榜 123456789
Bot: ✅ 已成功为用户 123456789 加入排行榜！
     昵称: 玩家B
     Rating: 13800
```

## 💡 注意事项

### 使用前提

1. ✅ 用户必须先在 [水鱼查分器](https://www.diving-fish.com/maimaidx/prober/) 绑定 QQ 号
2. ✅ 用户需要在水鱼查分器中**关闭隐私设置**（允许第三方查询）
3. ✅ Developer Token 有请求频率限制，请合理使用

### 功能特点

- 🔄 自动更新时间：
  - 成绩数据：每天凌晨 0:00
  - 别名数据：每天凌晨 0:05
  - 用户昵称：每 5 分钟
- 📊 排行榜默认显示歌曲的最高难度，可通过参数指定其他难度
- 🎯 排行榜最多显示前 20 名，避免图片过长
- 👥 昵称优先显示群名片，如无群名片则显示 QQ 昵称
- 🔄 用户加入排行榜时会自动刷新该群所有成员的昵称

## 💾 数据存储

插件使用 **SQLite 数据库**存储数据，自动创建以下文件：

### 主数据库
- 📂 `data/maimai_raking/`
  - 📄 `maimai_raking.db` - 主数据库文件
    - `groups` 表 - 群组配置信息
    - `users` 表 - 用户基本信息
    - `user_groups` 表 - 用户-群组关系
    - `records` 表 - 用户成绩记录

### 缓存数据库
- 📂 `data/maimai_cache/`
  - 📄 `cache.db` - 缓存数据库文件
    - `alias_cache` 表 - 别名数据缓存
    - `cover_cache` 表 - 歌曲封面缓存（BLOB）

### 数据库优势

- ⚡ 高性能：查询速度快，支持索引
- 🔒 数据安全：支持事务，防止数据损坏
- 🔄 并发友好：自动处理并发访问
- 💪 易于维护：标准 SQL 操作，便于管理

## 🛠️ 技术栈

- **NoneBot2** - 强大的 Python 聊天机器人框架
- **OneBot V11** - 标准的聊天机器人协议适配器
- **SQLite** - 轻量级数据库，无需额外配置
- **httpx** - 异步 HTTP 客户端
- **Pillow** - 图片处理库
- **APScheduler** - 定时任务调度

## 📄 开源协议

本项目采用 [MIT License](LICENSE) 开源协议

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

如果你有任何建议或发现了 Bug，请：
1. 在 GitHub 上提交 Issue
2. Fork 本项目并提交 Pull Request
3. 联系作者反馈问题

## 🔗 相关链接

- [NoneBot2 文档](https://nonebot.dev/)
- [水鱼查分器](https://www.diving-fish.com/maimaidx/prober/)
- [舞萌 DX 别名库](https://www.yuzuchan.moe/mai/alias)
- [OneBot 协议](https://onebot.dev/)

## 📝 更新日志

### v0.1.0
- ✨ 初始版本发布
- 🎮 支持分群排行榜管理
- 🎵 支持歌曲查询和排行榜展示
- 🔄 自动更新成绩和别名数据
- 💾 使用 SQLite 数据库存储
- 👥 智能群昵称显示和自动更新
- 🖼️ 美观的排行榜图片生成
- 🏆 Rating 排行榜功能（`wmrt` 命令）
- 📊 支持分段 Rating 查询（`wmrt1`-`wmrt9`）
- ✂️ 昵称自动截断（超过 12 字符添加省略号）

## 👨‍💻 致谢

- 感谢 [水鱼查分器](https://www.diving-fish.com/maimaidx/prober/) 提供的 API 支持
- 感谢 [柚子酱的舞萌别名库](https://www.yuzuchan.moe/mai/alias) 提供的别名数据
- 感谢 NoneBot2 社区的支持

---

**本项目由 AI 辅助编写** 🤖✨
